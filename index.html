<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RotaFlow Pro | Gerenciador de Entregas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Arquivo de Clientes Externo -->
    <script src="clientes.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Otimiza√ß√µes Mobile */
        body { -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Anima√ß√µes */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 4px solid #3b82f6; display: flex; align-items: center; animation: slideIn 0.3s ease; max-width: 90vw; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Badges e Status */
        .status-badge { font-size: 0.75rem; font-weight: 700; padding: 2px 8px; border-radius: 9999px; text-transform: uppercase; letter-spacing: 0.05em; }
        
        /* Modal Transitions */
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body class="text-gray-800 antialiased pb-24">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Header Fixo -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="container mx-auto max-w-5xl px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-brand-600 text-white p-2 rounded-lg shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 7m0 13V7" /></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 leading-tight">RotaFlow</h1>
                    <p class="text-xs text-gray-500" id="header-date">Carregando...</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="App.ui.toggleMenu()" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>
                </button>
            </div>
        </div>
        
        <!-- Menu Dropdown -->
        <div id="main-menu" class="hidden absolute right-4 top-16 bg-white rounded-xl shadow-xl border border-gray-100 w-48 overflow-hidden">
            <button onclick="App.controllers.novaRota()" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-center gap-2 text-red-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Nova Rota (Reset)
            </button>
            <div class="border-t border-gray-100"></div>
            <button onclick="App.ui.modalExport.open()" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Exportar Backup
            </button>
            <button onclick="document.getElementById('input-carregar-arquivo').click()" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                Carregar Backup
            </button>
        </div>
    </header>

    <main class="container mx-auto max-w-5xl px-4 py-6">
        
        <!-- KPIs / Placar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="kpi-container">
            <!-- Injetado via JS -->
        </div>

        <!-- Filtros de Regi√£o -->
        <div class="flex gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar" id="filtros-regiao">
            <!-- Injetado via JS -->
        </div>

        <!-- Bot√£o Flutuante (FAB) para Lan√ßamento -->
        <button onclick="App.ui.modalLancamento.open()" class="fixed bottom-6 right-6 bg-brand-600 text-white rounded-full p-4 shadow-lg hover:bg-brand-700 transition-transform hover:scale-105 z-40 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
        </button>

        <!-- Lista de Entregas -->
        <div id="lista-entregas" class="space-y-4 min-h-[200px]">
            <!-- Injetado via JS -->
        </div>
        
        <div id="lista-vazia" class="hidden flex-col items-center justify-center py-12 text-gray-400">
            <svg class="w-16 h-16 mb-4 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 001-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg>
            <p>Nenhuma entrega nesta regi√£o.</p>
        </div>

    </main>

    <!-- ================= MODAIS ================= -->

    <!-- Modal Lan√ßamento -->
    <div id="modal-lancamento" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 modal-backdrop transition-opacity" onclick="App.ui.modalLancamento.close()"></div>
        <div class="absolute bottom-0 md:top-10 md:bottom-auto md:left-1/2 md:-translate-x-1/2 w-full md:max-w-2xl bg-white md:rounded-xl rounded-t-2xl shadow-2xl h-[90vh] md:h-auto flex flex-col modal-content">
            
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold text-gray-800">Nova Entrega</h3>
                <button onclick="App.ui.modalLancamento.close()" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>

            <div class="overflow-y-auto p-4 flex-1 space-y-5">
                <!-- Cliente -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                    <input type="text" id="input-cliente" list="lista-clientes-datalist" class="w-full rounded-lg border-gray-300 border p-3 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all" placeholder="Buscar cliente..." autocomplete="off">
                    <datalist id="lista-clientes-datalist"></datalist>
                    
                    <div id="info-cliente-preview" class="hidden mt-2 text-sm bg-blue-50 text-blue-800 p-3 rounded-lg border border-blue-100">
                        <!-- Preenchido via JS -->
                    </div>
                </div>

                <!-- Regi√£o -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Regi√£o <span class="text-red-500">*</span></label>
                    <div class="grid grid-cols-4 gap-2 text-sm" id="container-radio-regiao">
                        <!-- Gerado via JS -->
                    </div>
                </div>

                <!-- Adicionar Cestas -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <label class="block text-sm font-bold text-gray-700 mb-3">Montar Pedido</label>
                    
                    <div class="flex gap-2 mb-3">
                        <select id="select-cesta" class="flex-1 rounded-lg border-gray-300 border p-2 text-sm">
                            <option value="ESPECIAL" data-valor="000.00">ESPECIAL</option>
                            <option value="Mini Bonini" data-valor="165.00">Mini Bonini</option>
                            <option value="Mini Koblenz" data-valor="170.00">Mini Koblenz</option>
                            <option value="Pequena Bonini" data-valor="215.00">Pequena Bonini</option>
                            <option value="Pequena Koblenz" data-valor="220.00">Pequena Koblenz</option>
                            <option value="M√©dia Bonini" data-valor="320.00">M√©dia Bonini</option>
                            <option value="M√©dia Koblenz" data-valor="325.00">M√©dia Koblenz</option>
                            <option value="Grande Bonini" data-valor="380.00">Grande Bonini</option>
                            <option value="Grande Koblenz" data-valor="390.00">Grande Koblenz</option>
                        </select>
                        <input type="number" id="qtd-cesta" value="1" min="1" class="w-16 text-center rounded-lg border-gray-300 border p-2">
                    </div>

                    <!-- Op√ß√µes Avan√ßadas (Toggle) -->
                    <div class="mb-3">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="check-alterada" class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                            <span class="ms-3 text-sm font-medium text-gray-700">Cesta Alterada?</span>
                        </label>
                    </div>

                    <div id="box-detalhes-alterada" class="hidden space-y-2 mb-3 bg-amber-50 p-3 rounded border border-amber-200">
                        <textarea id="txt-alteracao" placeholder="Ex: TIRA Arroz, P√ïE Caf√©..." class="w-full text-sm p-2 rounded border border-amber-200"></textarea>
                        <div class="flex gap-2">
                            <label class="flex items-center text-xs"><input type="checkbox" class="mr-1" value="Arroz" name="partes_alt">Arroz</label>
                            <label class="flex items-center text-xs"><input type="checkbox" class="mr-1" value="Alimento" name="partes_alt">Alimento</label>
                            <label class="flex items-center text-xs"><input type="checkbox" class="mr-1" value="Limpeza" name="partes_alt">Limpeza</label>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="text-xs font-semibold text-gray-500 uppercase">Brindes:</span>
                        <label class="flex items-center text-xs bg-white px-2 py-1 rounded border"><input type="checkbox" class="mr-1" value="Ovo" name="brindes">Ovo</label>
                        <label class="flex items-center text-xs bg-white px-2 py-1 rounded border"><input type="checkbox" class="mr-1" value="Amaciante" name="brindes">Amaciante</label>
                        <label class="flex items-center text-xs bg-white px-2 py-1 rounded border"><input type="checkbox" class="mr-1" value="Cafe 250g" name="brindes">Caf√©</label>
                    </div>

                    <button onclick="App.controllers.adicionarItemAoCarrinho()" class="w-full bg-gray-800 text-white py-2 rounded-lg text-sm font-medium hover:bg-gray-900 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        Adicionar ao Carrinho
                    </button>
                </div>

                <!-- Carrinho Visual -->
                <div id="carrinho-visual" class="space-y-2">
                    <!-- Itens adicionados aparecem aqui -->
                </div>
                
                <div>
                     <label class="block text-sm font-medium text-gray-700">Obs Geral</label>
                     <input type="text" id="input-obs-geral" class="w-full mt-1 border-gray-300 rounded-lg p-2 border" placeholder="Casa port√£o azul...">
                </div>

                <div class="flex justify-between items-center pt-2 border-t">
                    <span class="text-gray-600">Total Previsto:</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-400">R$</span>
                        <input type="number" id="input-valor-final" step="0.01" class="text-xl font-bold text-gray-900 w-28 text-right bg-transparent border-none focus:ring-0 p-0" placeholder="0.00">
                    </div>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 md:rounded-b-xl flex gap-3">
                <button onclick="App.ui.modalLancamento.close()" class="flex-1 py-3 text-gray-600 font-medium hover:bg-gray-200 rounded-lg transition-colors">Cancelar</button>
                <button onclick="App.controllers.salvarEntrega()" class="flex-[2] py-3 bg-brand-600 text-white font-bold rounded-lg shadow-lg hover:bg-brand-700 transition-colors">Confirmar Lan√ßamento</button>
            </div>
        </div>
    </div>

    <!-- Modal Pagamento -->
    <div id="modal-pagamento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="bg-green-600 p-4 text-white text-center">
                <h3 class="text-lg font-bold">Concluir Entrega</h3>
                <p class="text-green-100 text-sm" id="pag-cliente-nome">Cliente</p>
                <p class="text-2xl font-bold mt-1" id="pag-valor-total">R$ 0,00</p>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-600 font-medium">Forma de Pagamento:</p>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="pagamento" value="DINHEIRO" class="w-5 h-5 text-green-600 rounded"> <span class="ml-3 font-medium">Dinheiro</span></label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="pagamento" value="PIX" class="w-5 h-5 text-green-600 rounded"> <span class="ml-3 font-medium">PIX</span></label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="pagamento" value="CART√ÉO" class="w-5 h-5 text-green-600 rounded"> <span class="ml-3 font-medium">Cart√£o</span></label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" name="pagamento" value="S√ì ENTREGAR" class="w-5 h-5 text-green-600 rounded"> <span class="ml-3 font-medium">S√≥ Entregar</span></label>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="document.getElementById('modal-pagamento').classList.add('hidden')" class="flex-1 py-2 text-gray-600 border rounded-lg">Voltar</button>
                    <button onclick="App.controllers.confirmarPagamento()" class="flex-1 py-2 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal WhatsApp -->
    <div id="modal-whatsapp" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
            <div class="p-4 border-b flex justify-between items-center bg-green-50 rounded-t-xl">
                <h3 class="font-bold text-green-800 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    WhatsApp
                </h3>
                <button onclick="document.getElementById('modal-whatsapp').classList.add('hidden')" class="text-gray-400">X</button>
            </div>
            <div class="p-2 space-y-2">
                <button onclick="App.controllers.enviarMsgZap(1)" class="w-full text-left p-3 rounded hover:bg-green-50 text-sm font-medium text-gray-700 border border-transparent hover:border-green-200 transition-all">üöó Aviso: Chegando em 10 min</button>
                <button onclick="App.controllers.enviarMsgZap(2)" class="w-full text-left p-3 rounded hover:bg-green-50 text-sm font-medium text-gray-700 border border-transparent hover:border-green-200 transition-all">üö™ Aviso: Cheguei no local</button>
                <button onclick="App.controllers.enviarMsgZap(3)" class="w-full text-left p-3 rounded hover:bg-green-50 text-sm font-medium text-gray-700 border border-transparent hover:border-green-200 transition-all">üí∞ Dados do PIX</button>
                <button onclick="App.controllers.enviarMsgZap(4)" class="w-full text-left p-3 rounded hover:bg-red-50 text-sm font-medium text-red-700 border border-red-100 transition-all">üö® Pedido p/ Montador</button>
            </div>
        </div>
    </div>

    <!-- Modal Exportar -->
    <div id="modal-exportar" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Exportar Rota</h3>
            <div class="space-y-2 mb-4">
                <p class="text-sm text-gray-500 mb-2">Selecione as regi√µes:</p>
                <div class="grid grid-cols-2 gap-2" id="export-regioes-list">
                    <!-- Checkboxes injetados -->
                </div>
            </div>
            <button onclick="App.controllers.baixarBackup()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Baixar JSON</button>
            <button onclick="App.ui.modalExport.close()" class="w-full mt-2 text-gray-500 py-2 hover:bg-gray-100 rounded-lg">Cancelar</button>
        </div>
    </div>

    <input type="file" id="input-carregar-arquivo" class="hidden" accept=".json,application/json" onchange="App.controllers.importarBackup(this)">

    <!-- JAVASCRIPT APP -->
    <script>
        /**
         * RotaFlow Core Logic
         * Arquitetura: Singleton State Management
         */

        const CONSTANTS = {
            PIX_NOME: "Osvaldo Sereia Junior",
            PIX_CELULAR: "65984491018",
            NUMERO_GERENTE: "5565996884599",
            REGIOES: ["VG", "CUIABA", "COXIPO", "CPA"],
            STORAGE_KEY: "rotaflow_v2_db"
        };

        // --- Store (Estado da Aplica√ß√£o) ---
        const Store = {
            data: {
                rotaAtiva: null,
                regiaoFiltro: 'VG',
                carrinhoTemp: [],
                entregaEmAcaoId: null // ID da entrega sendo paga ou contatada
            },

            init() {
                const saved = localStorage.getItem(CONSTANTS.STORAGE_KEY);
                if (saved) {
                    this.data.rotaAtiva = JSON.parse(saved);
                    // Garantir compatibilidade de estrutura se houver dados antigos
                    if(!Array.isArray(this.data.rotaAtiva.entregas)) this.data.rotaAtiva.entregas = [];
                } else {
                    this.novaRota();
                }
            },

            novaRota() {
                this.data.rotaAtiva = {
                    id: Date.now(),
                    dataCriacao: new Date().toISOString(),
                    entregas: []
                };
                this.save();
            },

            save() {
                localStorage.setItem(CONSTANTS.STORAGE_KEY, JSON.stringify(this.data.rotaAtiva));
                App.ui.render();
            },

            getEntregasFiltradas() {
                if (!this.data.rotaAtiva) return [];
                let lista = this.data.rotaAtiva.entregas.filter(e => e.regiao === this.data.regiaoFiltro);
                
                // Ordena√ß√£o: Pendentes Primeiro -> Finalizadas por hor√°rio
                return lista.sort((a, b) => {
                    if (a.status === 'Pendente' && b.status !== 'Pendente') return -1;
                    if (a.status !== 'Pendente' && b.status === 'Pendente') return 1;
                    if (a.status !== 'Pendente' && b.status !== 'Pendente') {
                        return new Date(a.updatedAt || 0) - new Date(b.updatedAt || 0); // Mais antigos primeiro no final
                    }
                    return 0; // Ordem de cria√ß√£o
                });
            },

            addEntrega(entrega) {
                this.data.rotaAtiva.entregas.push(entrega);
                this.save();
            },

            updateEntrega(id, updates) {
                const index = this.data.rotaAtiva.entregas.findIndex(e => e.id == id);
                if (index !== -1) {
                    this.data.rotaAtiva.entregas[index] = { ...this.data.rotaAtiva.entregas[index], ...updates, updatedAt: new Date().toISOString() };
                    
                    // Se foi finalizada, move pro final da lista l√≥gica (embora a ordena√ß√£o visual j√° cuide disso)
                    if(updates.status && updates.status !== 'Pendente') {
                        const item = this.data.rotaAtiva.entregas.splice(index, 1)[0];
                        this.data.rotaAtiva.entregas.push(item);
                    }
                    this.save();
                }
            },

            moverEntrega(id, direcao) {
                const entregas = this.data.rotaAtiva.entregas;
                const regiao = this.data.regiaoFiltro;
                
                // Pegar apenas √≠ndices das entregas da regi√£o atual E pendentes
                const indicesRegiao = entregas
                    .map((e, i) => ({ ...e, originalIndex: i }))
                    .filter(e => e.regiao === regiao && e.status === 'Pendente');

                const itemRegiaoIndex = indicesRegiao.findIndex(e => e.id == id);
                if (itemRegiaoIndex === -1) return;

                const targetRegiaoIndex = direcao === 'cima' ? itemRegiaoIndex - 1 : itemRegiaoIndex + 1;

                if (targetRegiaoIndex >= 0 && targetRegiaoIndex < indicesRegiao.length) {
                    const idxA = indicesRegiao[itemRegiaoIndex].originalIndex;
                    const idxB = indicesRegiao[targetRegiaoIndex].originalIndex;
                    
                    // Swap no array principal
                    [entregas[idxA], entregas[idxB]] = [entregas[idxB], entregas[idxA]];
                    this.save();
                }
            }
        };

        // --- Helpers ---
        const Utils = {
            formatMoeda: (valor) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0),
            formatData: (iso) => new Date(iso).toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' }),
            formatHora: (iso) => iso ? new Date(iso).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '',
            toast: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast text-sm font-medium ${type === 'error' ? 'border-red-500 text-red-800' : 'text-gray-800'}`;
                el.innerHTML = msg;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(100%)';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            }
        };

        // --- UI Manager ---
        const App = {
            ui: {
                modalLancamento: {
                    open: () => {
                        document.getElementById('modal-lancamento').classList.remove('hidden');
                        Store.data.carrinhoTemp = [];
                        App.ui.renderCarrinho();
                        document.getElementById('input-cliente').value = '';
                        document.getElementById('info-cliente-preview').classList.add('hidden');
                        document.getElementById('input-valor-final').value = '';
                    },
                    close: () => document.getElementById('modal-lancamento').classList.add('hidden')
                },
                modalExport: {
                    open: () => {
                        const container = document.getElementById('export-regioes-list');
                        container.innerHTML = CONSTANTS.REGIOES.map(r => `
                            <label class="flex items-center space-x-2 border p-2 rounded cursor-pointer">
                                <input type="checkbox" checked value="${r}" class="text-blue-600 rounded focus:ring-blue-500">
                                <span class="text-sm text-gray-700">${r}</span>
                            </label>
                        `).join('');
                        document.getElementById('modal-exportar').classList.remove('hidden');
                    },
                    close: () => document.getElementById('modal-exportar').classList.add('hidden')
                },

                toggleMenu: () => {
                    const menu = document.getElementById('main-menu');
                    menu.classList.toggle('hidden');
                },

                renderCarrinho: () => {
                    const container = document.getElementById('carrinho-visual');
                    const totalInput = document.getElementById('input-valor-final');
                    
                    if(Store.data.carrinhoTemp.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-400 text-sm py-2">Nenhum item adicionado</div>';
                        totalInput.value = '';
                        return;
                    }

                    let totalCalculado = 0;
                    container.innerHTML = Store.data.carrinhoTemp.map((item, idx) => {
                        totalCalculado += (item.valor * item.qtd);
                        return `
                        <div class="flex justify-between items-start bg-white p-2 rounded border border-gray-100 shadow-sm animate-in fade-in">
                            <div>
                                <p class="text-sm font-bold text-gray-800">${item.qtd}x ${item.nome}</p>
                                ${item.tipo === 'Alterada' ? `<p class="text-xs text-amber-600 font-medium">‚ö†Ô∏è Alterada: ${item.codigoAlterada}</p>` : ''}
                                ${item.brindes && item.brindes.length ? `<p class="text-xs text-pink-500">+ ${item.brindes.join(', ')}</p>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-blue-600">${Utils.formatMoeda(item.valor * item.qtd)}</span>
                                <button onclick="App.controllers.removerItemCarrinho(${idx})" class="text-red-400 hover:text-red-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        </div>
                    `}).join('');

                    // S√≥ atualiza se o usu√°rio n√£o tiver editado manualmente (ou se estiver vazio)
                    if (!totalInput.value || parseFloat(totalInput.value) === 0) {
                        totalInput.value = totalCalculado.toFixed(2);
                    }
                },

                render: () => {
                    const entregas = Store.getEntregasFiltradas();
                    const container = document.getElementById('lista-entregas');
                    const emptyState = document.getElementById('lista-vazia');
                    
                    // Header Data
                    document.getElementById('header-date').innerText = Utils.formatData(Store.data.rotaAtiva.dataCriacao);

                    // KPIs
                    const totalGeral = Store.data.rotaAtiva.entregas.length;
                    const pendentesGeral = Store.data.rotaAtiva.entregas.filter(e => e.status === 'Pendente').length;
                    const entreguesGeral = Store.data.rotaAtiva.entregas.filter(e => e.status === 'Entregue');
                    const receita = entreguesGeral.reduce((acc, e) => acc + (parseFloat(e.valorTotalAjustado || 0)), 0);

                    document.getElementById('kpi-container').innerHTML = `
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                            <p class="text-xs text-gray-500 uppercase font-bold">Pendentes</p>
                            <p class="text-2xl font-bold text-blue-600">${pendentesGeral}</p>
                        </div>
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                            <p class="text-xs text-gray-500 uppercase font-bold">Entregues</p>
                            <p class="text-2xl font-bold text-green-600">${entreguesGeral.length}</p>
                        </div>
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 col-span-2">
                            <p class="text-xs text-gray-500 uppercase font-bold">Receita (Pix/Din/Cart√£o)</p>
                            <p class="text-2xl font-bold text-gray-800">${Utils.formatMoeda(receita)}</p>
                        </div>
                    `;

                    // Filtros
                    const regioesHtml = CONSTANTS.REGIOES.map(r => {
                        const count = Store.data.rotaAtiva.entregas.filter(e => e.regiao === r && e.status === 'Pendente').length;
                        const active = Store.data.regiaoFiltro === r;
                        return `
                            <button onclick="App.controllers.mudarFiltro('${r}')" class="whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium transition-colors border ${active ? 'bg-brand-600 text-white border-brand-600 shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}">
                                ${r} <span class="${active ? 'bg-brand-500 text-white' : 'bg-gray-200 text-gray-600'} text-xs py-0.5 px-1.5 rounded-full ml-1">${count}</span>
                            </button>
                        `;
                    }).join('');
                    document.getElementById('filtros-regiao').innerHTML = regioesHtml;

                    // Lista
                    if (entregas.length === 0) {
                        container.innerHTML = '';
                        emptyState.classList.remove('hidden');
                        emptyState.classList.add('flex');
                        return;
                    }
                    
                    emptyState.classList.add('hidden');
                    emptyState.classList.remove('flex');

                    container.innerHTML = entregas.map((entrega, index) => {
                        const isPendente = entrega.status === 'Pendente';
                        const total = parseFloat(entrega.valorTotalAjustado || 0);
                        
                        // Resumo dos itens para o card
                        const resumoItens = entrega.cestas.map(c => 
                            `${c.qtd}x ${c.nome.split(' ')[0]} ${c.tipo==='Alterada'?'(Alt)':''}`
                        ).join(', ');

                        return `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden relative transition-transform transform ${isPendente ? 'hover:scale-[1.01]' : 'opacity-70 bg-gray-50'}">
                            ${!isPendente ? `
                                <div class="absolute inset-0 z-10 flex items-center justify-center pointer-events-none">
                                    <div class="bg-white/90 border-2 ${entrega.status === 'Entregue' ? 'border-green-500 text-green-600' : 'border-red-500 text-red-600'} px-4 py-1 rounded-lg text-xl font-black uppercase rotate-[-12deg] shadow-lg">
                                        ${entrega.status}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="p-4 flex gap-3">
                                <!-- Coluna Controle -->
                                <div class="flex flex-col gap-1 pt-1 justify-start">
                                    <button ${!isPendente ? 'disabled' : ''} onclick="App.controllers.moverEntrega(${entrega.id}, 'cima')" class="p-1 text-gray-300 hover:text-brand-600 disabled:opacity-0"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg></button>
                                    <button ${!isPendente ? 'disabled' : ''} onclick="App.controllers.moverEntrega(${entrega.id}, 'baixo')" class="p-1 text-gray-300 hover:text-brand-600 disabled:opacity-0"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button>
                                </div>

                                <!-- Coluna Info -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-bold text-gray-900 truncate pr-2">${entrega.cliente.nome}</h4>
                                        <span class="font-bold text-brand-700 whitespace-nowrap">${Utils.formatMoeda(total)}</span>
                                    </div>
                                    <p class="text-sm text-gray-500 truncate mb-1">${entrega.cliente.endereco || 'Sem endere√ßo'}</p>
                                    
                                    <div class="bg-blue-50 text-blue-800 text-xs p-2 rounded mb-2 font-medium">
                                        üì¶ ${resumoItens}
                                        ${entrega.observacao ? `<br><span class="text-red-500 font-bold">OBS: ${entrega.observacao}</span>` : ''}
                                    </div>

                                    ${entrega.status === 'Entregue' ? `<p class="text-xs text-green-700 font-medium text-right mb-2">Pago via: ${entrega.formaPagamento.join(', ')} √†s ${Utils.formatHora(entrega.updatedAt)}</p>` : ''}

                                    <!-- A√ß√µes -->
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="App.controllers.abrirZap(${entrega.id})" class="flex-1 bg-green-100 text-green-700 py-2 rounded-lg text-sm font-semibold hover:bg-green-200 flex items-center justify-center gap-1">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981z"/></svg> Zap
                                        </button>
                                        <button onclick="App.controllers.abrirMapa('${entrega.cliente.endereco}')" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-semibold hover:bg-gray-200">Mapa</button>
                                        
                                        ${isPendente ? `
                                            <button onclick="App.controllers.iniciarPagamento(${entrega.id})" class="flex-[2] bg-brand-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-brand-700 shadow-sm shadow-blue-200">ENTREGAR</button>
                                            <button onclick="App.controllers.cancelarEntrega(${entrega.id})" class="px-3 text-red-400 hover:bg-red-50 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            },

            controllers: {
                novaRota: () => {
                    if(confirm('Isso apagar√° a rota atual e criar√° uma nova. Confirmar?')) {
                        Store.novaRota();
                        window.location.reload();
                    }
                },
                
                mudarFiltro: (regiao) => {
                    Store.data.regiaoFiltro = regiao;
                    App.ui.render();
                },

                // --- L√≥gica de Carrinho e Lan√ßamento ---
                toggleCheckAlterada: () => {
                    const check = document.getElementById('check-alterada');
                    const box = document.getElementById('box-detalhes-alterada');
                    if(check.checked) box.classList.remove('hidden');
                    else box.classList.add('hidden');
                },

                adicionarItemAoCarrinho: () => {
                    const select = document.getElementById('select-cesta');
                    const qtd = parseInt(document.getElementById('qtd-cesta').value);
                    const option = select.options[select.selectedIndex];
                    const isAlterada = document.getElementById('check-alterada').checked;
                    
                    if(qtd < 1) return Utils.toast('Quantidade inv√°lida', 'error');

                    const item = {
                        nome: select.value,
                        valor: parseFloat(option.dataset.valor || 0),
                        qtd: qtd,
                        tipo: isAlterada ? 'Alterada' : 'Normal',
                        codigoAlterada: isAlterada ? document.getElementById('txt-alteracao').value : '',
                        partesAlteradas: isAlterada ? Array.from(document.querySelectorAll('input[name="partes_alt"]:checked')).map(el => el.value) : [],
                        brindes: Array.from(document.querySelectorAll('input[name="brindes"]:checked')).map(el => el.value)
                    };

                    Store.data.carrinhoTemp.push(item);
                    App.ui.renderCarrinho();
                    
                    // Reset fields
                    document.getElementById('check-alterada').checked = false;
                    App.controllers.toggleCheckAlterada();
                    document.getElementById('qtd-cesta').value = 1;
                    document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
                },

                removerItemCarrinho: (index) => {
                    Store.data.carrinhoTemp.splice(index, 1);
                    App.ui.renderCarrinho();
                },

                salvarEntrega: () => {
                    const nome = document.getElementById('input-cliente').value.trim();
                    const regiaoInput = document.querySelector('input[name="regiao"]:checked');
                    
                    if(!nome) return Utils.toast('Informe o nome do cliente', 'error');
                    if(!regiaoInput) return Utils.toast('Selecione a regi√£o', 'error');
                    if(Store.data.carrinhoTemp.length === 0) return Utils.toast('Adicione cestas ao pedido', 'error');

                    // Buscar dados do cliente no DB ou criar novo
                    let clienteData = { nome: nome, endereco: '', celular: '' };
                    if (typeof CLIENTES_DB !== 'undefined') {
                        const found = CLIENTES_DB.find(c => c.nome.toLowerCase() === nome.toLowerCase());
                        if (found) clienteData = found;
                    }
                    
                    const valorFinalManual = parseFloat(document.getElementById('input-valor-final').value) || 0;

                    const novaEntrega = {
                        id: Date.now(),
                        cliente: clienteData,
                        regiao: regiaoInput.value,
                        cestas: [...Store.data.carrinhoTemp],
                        valorTotalAjustado: valorFinalManual,
                        observacao: document.getElementById('input-obs-geral').value,
                        status: 'Pendente',
                        updatedAt: new Date().toISOString(),
                        formaPagamento: []
                    };

                    Store.addEntrega(novaEntrega);
                    App.ui.modalLancamento.close();
                    Store.data.regiaoFiltro = regiaoInput.value; // Pula para a aba da regi√£o
                    App.ui.render();
                    Utils.toast('Entrega lan√ßada com sucesso!');
                },

                // --- A√ß√µes na Lista ---
                moverEntrega: (id, dir) => Store.moverEntrega(id, dir),
                
                cancelarEntrega: (id) => {
                    if(confirm('Cancelar esta entrega?')) {
                        Store.updateEntrega(id, { status: 'Cancelada' });
                        App.ui.render();
                    }
                },

                abrirMapa: (endereco) => {
                    if(!endereco || endereco.length < 3) return Utils.toast('Endere√ßo n√£o cadastrado', 'error');
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(endereco)}`, '_blank');
                },

                // --- Pagamento ---
                iniciarPagamento: (id) => {
                    Store.data.entregaEmAcaoId = id;
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == id);
                    document.getElementById('pag-cliente-nome').innerText = entrega.cliente.nome;
                    document.getElementById('pag-valor-total').innerText = Utils.formatMoeda(entrega.valorTotalAjustado);
                    
                    document.querySelectorAll('input[name="pagamento"]').forEach(el => el.checked = false);
                    document.getElementById('modal-pagamento').classList.remove('hidden');
                },

                confirmarPagamento: () => {
                    const pags = Array.from(document.querySelectorAll('input[name="pagamento"]:checked')).map(el => el.value);
                    if(pags.length === 0) return Utils.toast('Selecione uma forma de pagamento', 'error');

                    Store.updateEntrega(Store.data.entregaEmAcaoId, {
                        status: 'Entregue',
                        formaPagamento: pags
                    });

                    document.getElementById('modal-pagamento').classList.add('hidden');
                    
                    // Enviar Relat√≥rio R√°pido Zap
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == Store.data.entregaEmAcaoId);
                    App.controllers.enviarRelatorioFinalZap(entrega);
                    
                    App.ui.render();
                    Utils.toast('Entrega conclu√≠da! üéâ');
                },

                // --- WhatsApp Integration ---
                abrirZap: (id) => {
                    Store.data.entregaEmAcaoId = id;
                    document.getElementById('modal-whatsapp').classList.remove('hidden');
                },

                enviarMsgZap: (tipo) => {
                    const entrega = Store.data.rotaAtiva.entregas.find(e => e.id == Store.data.entregaEmAcaoId);
                    let num = entrega.cliente.celular.replace(/\D/g, '');
                    if(!num) {
                        if(tipo !== 4) return Utils.toast('Cliente sem celular cadastrado', 'error');
                        else num = CONSTANTS.NUMERO_GERENTE;
                    } else if(!num.startsWith('55')) {
                        num = '55' + num;
                    }

                    let msg = '';
                    const valor = Utils.formatMoeda(entrega.valorTotalAjustado);

                    switch(tipo) {
                        case 1: msg = `Ol√° ${entrega.cliente.nome.split(' ')[0]}! Aqui √© da Cesta B√°sica. Chegando em 10 minutos! üöö`; break;
                        case 2: msg = `Ol√°! O entregador chegou no seu endere√ßo.`; break;
                        case 3: msg = `Dados PIX:\nCelular: ${CONSTANTS.PIX_CELULAR}\nNome: ${CONSTANTS.PIX_NOME}\nValor: ${valor}`; break;
                        case 4: 
                            num = CONSTANTS.NUMERO_GERENTE;
                            msg = `*PEDIDO MONTADOR*\nRegi√£o: ${entrega.regiao}\n`;
                            entrega.cestas.forEach(c => {
                                msg += `\n- ${c.qtd}x ${c.nome} ${c.tipo==='Alterada' ? `(ALT: ${c.codigoAlterada})` : ''} ${c.brindes.length ? `+${c.brindes}`:''}`;
                            });
                            break;
                    }

                    window.open(`https://api.whatsapp.com/send?phone=${num}&text=${encodeURIComponent(msg)}`, '_blank');
                    document.getElementById('modal-whatsapp').classList.add('hidden');
                },

                enviarRelatorioFinalZap: (entrega) => {
                     const num = CONSTANTS.NUMERO_GERENTE; // Ou PIX_CELULAR conforme l√≥gica original
                     let msg = `*‚úÖ ENTREGA REALIZADA*\nCliente: ${entrega.cliente.nome}\nValor: ${Utils.formatMoeda(entrega.valorTotalAjustado)}\nPagamento: ${entrega.formaPagamento.join(', ')}\n\n`;
                     entrega.cestas.forEach(c => {
                         msg += `${c.qtd}x ${c.nome}\n`;
                     });
                     
                     // Pequeno delay para UX
                     setTimeout(() => {
                        if(confirm('Abrir WhatsApp para enviar comprovante ao gerente?')) {
                            window.open(`https://api.whatsapp.com/send?phone=${num}&text=${encodeURIComponent(msg)}`, '_blank');
                        }
                     }, 500);
                },

                // --- Backup System ---
                baixarBackup: () => {
                    const regioes = Array.from(document.querySelectorAll('#export-regioes-list input:checked')).map(el => el.value);
                    if(regioes.length === 0) return Utils.toast('Selecione ao menos uma regi√£o', 'error');

                    const backup = {
                        ...Store.data.rotaAtiva,
                        entregas: Store.data.rotaAtiva.entregas.filter(e => regioes.includes(e.regiao))
                    };

                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
                    const link = document.createElement("a");
                    link.setAttribute("href", dataStr);
                    link.setAttribute("download", `RotaBackup_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.json`);
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    App.ui.modalExport.close();
                },

                importarBackup: (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            if(json.entregas) {
                                Store.data.rotaAtiva = json;
                                Store.save();
                                window.location.reload();
                            } else {
                                throw new Error('Formato inv√°lido');
                            }
                        } catch(err) {
                            Utils.toast('Erro ao ler arquivo: ' + err.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            }
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            Store.init();
            App.ui.render();

            // Event Listeners Din√¢micos
            document.getElementById('check-alterada').addEventListener('change', App.controllers.toggleCheckAlterada);
            
            // Renderizar op√ß√µes de Regi√£o no Modal de Lan√ßamento
            const radioContainer = document.getElementById('container-radio-regiao');
            radioContainer.innerHTML = CONSTANTS.REGIOES.map(r => `
                <label class="cursor-pointer">
                    <input type="radio" name="regiao" value="${r}" class="peer sr-only" ${r === 'VG' ? 'checked' : ''}>
                    <div class="rounded-md border border-gray-200 bg-white p-2 text-center text-gray-600 peer-checked:border-brand-500 peer-checked:bg-brand-50 peer-checked:text-brand-700 transition-all font-semibold">
                        ${r}
                    </div>
                </label>
            `).join('');
            
            // Datalist population
            if(typeof CLIENTES_DB !== 'undefined') {
                const dl = document.getElementById('lista-clientes-datalist');
                CLIENTES_DB.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.nome;
                    dl.appendChild(opt);
                });

                // Auto-preencher preview
                document.getElementById('input-cliente').addEventListener('input', (e) => {
                    const val = e.target.value;
                    const found = CLIENTES_DB.find(c => c.nome.toLowerCase() === val.toLowerCase());
                    const preview = document.getElementById('info-cliente-preview');
                    if(found) {
                        preview.innerHTML = `<strong>Endere√ßo:</strong> ${found.endereco} <br> <strong>Cel:</strong> ${found.celular}`;
                        preview.classList.remove('hidden');
                    } else {
                        preview.classList.add('hidden');
                    }
                });
            }
        });

    </script>
</body>
</html>
